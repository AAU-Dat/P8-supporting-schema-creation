\subsection{Abstract Domains}\label{subsec:abstract-domains}

In the following sections we will describe the abstract domains of our value analysis.

\subsubsection{Abstract domain of strings as regular expressions}\label{subsubsec:abstract_domains_strings}

To represent the abstract domain of the family of SQL strings data types we have chosen regular expressions/languages.
Regular expressions/languages are chosen, as opposed to more powerful representations, for the decidable nature of inclusion and equality between them.

Let $REG$ denote the set of regular languages and
\begin{equation*}
    REG^{\leq n} = \{R \in REG \mid \forall w \in R : |w| \leq n\}.
\end{equation*}
In the following we do not distinguish between regular expressions and their languages.

% Tikzfigures
\begin{figure}
    \resizebox{7.5cm}{!}{
        \begin{tikzpicture}
            \filldraw[fill=white, draw=black] (2,2) circle (5cm);
            \node [draw] at (5,2) {\Huge$\overline{R}$};
            \filldraw[fill=gray!60, draw=black] (1,2) circle (2cm);
            \node [draw] at (1,2) {\Huge R};
            \node at (9.5, 2.5) {\huge $R \cup \overline{R} = \Sigma^*$};
            \node at (9.5, 1.5) {\huge $R \cap \overline{R} = \emptyset$};
        \end{tikzpicture}
    }
    \caption{Regular language partition}
    \label{fig:tikz-reg-partition}
\end{figure}

\autoref{fig:tikz-reg-partition} illustrates a simple regular language partition. The regular language $R$ is represented by the gray circle and its complement $\overline{R}$ is represented by the white circle. The two circles together represent the entire regular language $\Sigma^*$ and their intersection is the empty set $\emptyset$.

\begin{figure}[!htb]
    \resizebox{6.5cm}{!}{
        \begin{tikzpicture}[scale = 0.5]
            \usetikzlibrary{calc}
            \node (a) [state] {\Huge$R \cup \overline{R} = \top = \Sigma^*$};
            \node (b1) [state, shift={($(a.south)+(3cm, -2.5cm)$)}] {\Huge $R$};
            \node (b2) [state, shift={($(a.south)+(-3cm, -2.5cm)$)}]{\Huge $\overline{R}$};
            \node (c) [state, shift= {($(a.south) + (0cm, -5.5cm)$)}] {\Huge $R \cap \overline{R} = \bot = \emptyset$};
            \draw (a) to (b1);
            \draw (a) to (b2);
            \draw (b1) to (c);
            \draw (b2) to (c);
        \end{tikzpicture}
    }
    \caption{Regular language partition as a lattice}
    \label{fig:tikz-reg-partition-lattice}
\end{figure}
\autoref{fig:tikz-reg-partition-lattice} illustrates the regular language partition as a lattice. The top element $\top$ is the entire regular language $\Sigma^*$ and the bottom element $\bot$ is the empty set $\emptyset$. The regular language $R$ and its complement $\overline{R}$ are the two elements in the partition.

\subsubsection{Abstract domain of numbers as linear inequalities}\label{subsubsec:abstract_domains_numbers}

To represent the abstract domain of the family of SQL number data types when have chosen compound linear inequalities with mixed integer solutions that are algorithmically solvable with MILP solvers.
solvable compound linear inequalities with mixed integer solutions where chosen for the prevalence and speed of MILP solvers.

\subsubsection{Lattice partitions}

\begin{definition}
    Given a finite subset $X \subseteq S$ of a lattice $(S, \sqsubseteq, \sqcup, \sqcap)$ where $\bigsqcup X = \top$.
    A lattice partition of $S$ in respect to $X$ $p_{X}(S)$ is the minimum set where:
    \begin{itemize}
        \item $\forall x \in X: x \in p_X(S)$,
        \item $\forall x, y \in p_X(S) : x \sqcup y \in p_X(S)$,
        \item $\forall x, y \in p_X(S) : x \sqcap y \in p_X(S)$,
    \end{itemize}
\end{definition}

\begin{restatable}{theorem}{partition}\label{thm:partition}
    For a non-complete lattice $(S, \sqsubseteq, \sqcup, \sqcap)$ and a finite non-empty subset $X \subseteq S$ $(p_X(S), \sqsubseteq, \sqcup, \sqcap)$ is a finite and complete lattice.
\end{restatable}

\section{Abstract domain of tables}\label{sec:abstract_domain_of_tables}

In the following we consider a table $t$ as function from the domain of possible tuples in the table $\mathbb{T}$ to the codomain of natural (numbers including $0$) $\mathbb{N}$:
\begin{equation}
    t : \mathbb{T} \rightarrow \mathbb{N}.
\end{equation}
The function $t$ describe the number of a given tuple in a table.
We can then consider abstraction over the table $t$ by abstracting either the domain or codomain
This gives rise to a taxonomy of abstract domains of tables shown in \autoref{tab:taxonomy_of_abstract_domain_of_tables}.
In \autoref{tab:taxonomy_of_abstract_domain_of_tables} $\mathbb{T}^\#$ denotes an abstract domain of the set of possible tuples $\mathbb{T}$, such that it forms some complete lkjattice $(\mathbb{T}^\#, \sqsubseteq, \sqcap, \sqcup)$.

\begin{table}
    \caption{Taxonomy of abstract domains of tables}
    \centering
    \begin{tabular}{c|l|c}
    Name & Function & Supported \\
    \hline
    \hline
        Bag of tuples & $t : \mathbb{T} \rightarrow \mathbb{N}$ & \\
        Abstract bag of tuples & $t : \mathbb{T} \rightarrow \mathbb{N}^\#$ & \\
        Set of tuples & $t : \mathbb{T} \rightarrow 2$ & \\
        Bag of abstract tuples & $t : \mathbb{T}^\# \rightarrow \mathbb{N}$ & \\
        Abstract bag of abstract tuples & $t_\# : \mathbb{T}^\# \rightarrow \mathbb{N}^\#$ & \checkmark \\
        Set of abstract tuples & $t_2 : \mathbb{T}^\# \rightarrow 2$ & \checkmark \\
        Abstract tuple & $t_1 : 1 \rightarrow \mathbb{T}^\#$ & \checkmark \\
    \end{tabular}
    \label{tab:taxonomy_of_abstract_domain_of_tables}
\end{table}

\todo[inline]{
    Casper asks: Do bags form a lattice under union and intersection?
}

\paragraph{Abstract bag of abstract tuples}

\begin{equation*}
    (t_\# \sqcup t_\#')(e) = t_\#(e) + t_\#'(e)
\end{equation*}
\begin{equation*}
    (t_\# \sqcap t_\#')(e) = \max\{0^\#, t_\#(e) - t_\#'(e), t_\#'(e) - t_\#(e)\}
\end{equation*}
\begin{equation*}
    t_\# \sqsubseteq t_\#' \iff \forall e \in \mathbb{T}^\# : t_\#(e) \leq t_\#'(e)
\end{equation*}

\paragraph{Set of abstract tuples}

\begin{equation*}
    t_2 \sqcup t_2' = t_2 \cup t_2'
\end{equation*}
\begin{equation*}
    t_2 \sqcap t_2' = t_2 \cap t_2'
\end{equation*}
\begin{equation*}
    t_2 \sqsubseteq t_2' = t_2 \subseteq t_2'
\end{equation*}

\paragraph{Abstract tuple}

\begin{equation*}
    (t_1 \sqcup t_1')(\cdot) = t_1(\cdot) \sqcup t_1'(\cdot)
\end{equation*}
\begin{equation*}
    (t_1 \sqcap t_1')(\cdot) = t_1(\cdot) \sqcap t_1'(\cdot)
\end{equation*}
\begin{equation*}
    t_1 \sqsubseteq t_1' = t_1(\cdot) \sqsubseteq t_1'(\cdot)
\end{equation*}
\todo[inline]{Casper says: This is probably not necessary to write out.}

\begin{theorem}
    $\forall i \in \{1, 2, \#\} : (t_i, \sqsubseteq, \sqcup, \sqcap)$ is a complete lattice.
    %todo
    \todo{Casper says: This should be proved.}
\end{theorem}
