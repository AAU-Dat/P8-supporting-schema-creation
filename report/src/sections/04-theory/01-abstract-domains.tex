\subsection{Abstract Domains}\label{subsec:abstract-domains}

In the following sections we will describe the abstract domains of our value analysis.

\subsubsection{Abstract domain of strings as regular expressions}\label{subsubsec:abstract_domains_strings}

To represent the abstract domain of the family of SQL strings data types we have chosen regular expressions/languages.
Regular expressions/languages are chosen, as opposed to more powerful representations, for the decidable nature of inclusion and equality between them.

Let $REG$ denote the set of regular languages. % and
% \begin{equation*}
%     REG^{\leq n} = \{R \in REG \mid \forall w \in R : |w| \leq n\}.
% \end{equation*}
In the following we do not distinguish between regular expressions and their languages.

The lattice of $(REG, \subseteq, \cup, \cap)$ is a lattice but not a complete one as the set of regular languages is transfinite and closed under finite union and intersection, but not closed under transfinite union and intersection.
This is a problem: Essentially we can not employ Kleene fixed-point theorem (\autoref{thm:kleene_finite} or \autoref{thm:kleene_scott}) to prove termination of our analysis.

\subsubsection{Abstract domain of numbers as linear inequalities}\label{subsubsec:abstract_domains_numbers}

To represent the abstract domain of the family of SQL number data types when have chosen compound linear inequalities with mixed integer solutions that are algorithmically solvable with MILP solvers (henceforth linear inequalities).
Linear inequalities with mixed integer solutions where chosen for the prevalence and speed of MILP solvers.

Linear inequalities essentially have the same problem as regular expressions. Let $MILP^n$ represent the set of sets of solutions to linear inequalities with $n$ unknowns, then $(MILP^n, \subseteq, \cup, \cap)$ is a non-complete lattice.

\subsubsection{Cover lattice}

The resolve the issue presented above we introduce the notion of a cover lattice:

\begin{definition}
    A finite subset $X \subset S$ of a lattice $(S, \subseteq, \cup, \cap)$ is called a lattice cover whenever $\bigcup X = \top$ and $\bigcap X = \bot$.
\end{definition}

\begin{definition}
    Given a lattice cover $X$ of a lattice $(S, \subseteq, \cup, \cap)$.
    A cover lattice of $S$ in respect to $X$ denoted $\clattice{X}{S}$ is the minimum set where:
    \begin{itemize}
        \item $\forall x \in X: x \in \clattice{X}{S}$,
        \item $\forall x, y \in \clattice{X}{S} : x \cup y \in \clattice{X}{S}$,
        \item $\forall x, y \in \clattice{X}{S} : x \cap y \in \clattice{X}{S}$,
    \end{itemize}
\end{definition}

This gives rise to the following theorem:

\begin{restatable}{theorem}{partition}\label{thm:partition}
    For a non-complete lattice $(S, \subseteq, \cup, \cap)$ and lattice cover $X$ of $S$ the cover lattice $(\clattice{X}{S}, \subseteq, \cup, \cap)$ is a finite and complete lattice.
\end{restatable}

And the following lemmas immediately follow:

\begin{lemma}
    If $X$ is a lattice cover of $(REG, \subseteq, \cup, \cap)$ then $(\clattice{X}{REG}, \subseteq, \cup, \cap)$ is a complete lattice.
\end{lemma}

\begin{lemma}
    If $X$ is a lattice cover of $(MILP^n, \subseteq, \cup, \cap)$ then $(\clattice{X}{MILP^n}, \subseteq, \cup, \cap)$ is a complete lattice.
\end{lemma}

\begin{example}
    \autoref{fig:tikz-reg-partition} illustrates a simple lattice cover of the regular languages. The regular language $R$ is represented by the gray circle and its complement $\overline{R}$ is represented by the white circle. The union of the two regular language represent the entire regular language $\Sigma^*$ and their intersection is the empty set $\emptyset$.

    \autoref{fig:tikz-reg-partition-lattice} illustrates the cover lattice induced by the lattice cover. The top element $\top$ is the entire regular language $\Sigma^*$ and the bottom element $\bot$ is the empty set $\emptyset$.
\end{example}

% Tikzfigures
\begin{figure}
    \center
    \resizebox{7.5cm}{!}{
        \begin{tikzpicture}
            \filldraw[fill=white, draw=black] (2,2) circle (5cm);
            \node [draw] at (5,2) {\Huge$\overline{R}$};
            \filldraw[fill=gray!60, draw=black] (1,2) circle (2cm);
            \node [draw] at (1,2) {\Huge R};
            \node at (9.5, 2.5) {\huge $R \cup \overline{R} = \Sigma^*$};
            \node at (9.5, 1.5) {\huge $R \cap \overline{R} = \emptyset$};
        \end{tikzpicture}
    }
    \caption{Regular language partition}
    \label{fig:tikz-reg-partition}
\end{figure}


\begin{figure}[!htb]
    \center
    \resizebox{6.5cm}{!}{
        \begin{tikzpicture}[scale = 0.5]
            \usetikzlibrary{calc}
            \node (a) [state] {\Huge$R \cup \overline{R} = \top = \Sigma^*$};
            \node (b1) [state, shift={($(a.south)+(3cm, -2.5cm)$)}] {\Huge $R$};
            \node (b2) [state, shift={($(a.south)+(-3cm, -2.5cm)$)}]{\Huge $\overline{R}$};
            \node (c) [state, shift= {($(a.south) + (0cm, -5.5cm)$)}] {\Huge $R \cap \overline{R} = \bot = \emptyset$};
            \draw (a) to (b1);
            \draw (a) to (b2);
            \draw (b1) to (c);
            \draw (b2) to (c);
        \end{tikzpicture}
    }
    \caption{Regular language partition as a lattice}
    \label{fig:tikz-reg-partition-lattice}
\end{figure}

\section{Abstract domain of tables}\label{sec:abstract_domain_of_tables}

In the following we consider a table $t$ as function from the domain of possible tuples in the table $\mathbb{T}$ to the codomain of natural (numbers including $0$) $\mathbb{N}$:
\begin{equation}
    t : \mathbb{T} \rightarrow \mathbb{N}.
\end{equation}
The function $t$ describe the number of a given tuple in a table.
We can then consider abstraction over the table $t$ by abstracting either the domain or codomain
This gives rise to a taxonomy of abstract domains of tables shown in \autoref{tab:taxonomy_of_abstract_domain_of_tables}.
In \autoref{tab:taxonomy_of_abstract_domain_of_tables} $\mathbb{T}^\#$ denotes an abstract domain of the set of possible tuples $\mathbb{T}$, such that it forms some complete lkjattice $(\mathbb{T}^\#, \sqsubseteq, \sqcap, \sqcup)$.

\begin{table}
    \caption{Taxonomy of abstract domains of tables}
    \centering
    \begin{tabular}{c|l|c}
    Name & Function & Supported \\
    \hline
    \hline
        Bag of tuples & $t : \mathbb{T} \rightarrow \mathbb{N}$ & \\
        Abstract bag of tuples & $t : \mathbb{T} \rightarrow \mathbb{N}^\#$ & \\
        Set of tuples & $t : \mathbb{T} \rightarrow 2$ & \\
        Bag of abstract tuples & $t : \mathbb{T}^\# \rightarrow \mathbb{N}$ & \\
        Abstract bag of abstract tuples & $t_\# : \mathbb{T}^\# \rightarrow \mathbb{N}^\#$ & \checkmark \\
        Set of abstract tuples & $t_2 : \mathbb{T}^\# \rightarrow 2$ & \checkmark \\
        Abstract tuple & $t_1 : 1 \rightarrow \mathbb{T}^\#$ & \checkmark \\
    \end{tabular}
    \label{tab:taxonomy_of_abstract_domain_of_tables}
\end{table}

\todo[inline]{
    Casper asks: Do bags form a lattice under union and intersection?
}

\paragraph{Abstract bag of abstract tuples}

\begin{equation*}
    (t_\# \sqcup t_\#')(e) = t_\#(e) + t_\#'(e)
\end{equation*}
\begin{equation*}
    (t_\# \sqcap t_\#')(e) = \max\{0^\#, t_\#(e) - t_\#'(e), t_\#'(e) - t_\#(e)\}
\end{equation*}
\begin{equation*}
    t_\# \sqsubseteq t_\#' \iff \forall e \in \mathbb{T}^\# : t_\#(e) \leq t_\#'(e)
\end{equation*}

\paragraph{Set of abstract tuples}

\begin{equation*}
    t_2 \sqcup t_2' = t_2 \cup t_2'
\end{equation*}
\begin{equation*}
    t_2 \sqcap t_2' = t_2 \cap t_2'
\end{equation*}
\begin{equation*}
    t_2 \sqsubseteq t_2' = t_2 \subseteq t_2'
\end{equation*}

\paragraph{Abstract tuple}

\begin{equation*}
    (t_1 \sqcup t_1')(\cdot) = t_1(\cdot) \sqcup t_1'(\cdot)
\end{equation*}
\begin{equation*}
    (t_1 \sqcap t_1')(\cdot) = t_1(\cdot) \sqcap t_1'(\cdot)
\end{equation*}
\begin{equation*}
    t_1 \sqsubseteq t_1' = t_1(\cdot) \sqsubseteq t_1'(\cdot)
\end{equation*}
\todo[inline]{Casper says: This is probably not necessary to write out.}

\begin{theorem}
    $\forall i \in \{1, 2, \#\} : (t_i, \sqsubseteq, \sqcup, \sqcap)$ is a complete lattice.
    %todo
    \todo{Casper says: This should be proved.}
\end{theorem}
